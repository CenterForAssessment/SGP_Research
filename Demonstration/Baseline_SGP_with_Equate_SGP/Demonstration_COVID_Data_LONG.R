############################################################################################
###
### Script to Create Modified sgpData_LONG with a broken vertical scale to test
### impact of equateSGP on the calculation of student growth Percentiles
###
############################################################################################

### Load package
require(data.table)
require(SGP)

### LOAD WIDE file output and load
load("Data/Demonstration_COVID_SGP_WIDE_Data.Rdata")

### Subset out variables needed
variables.to.keep <- c("ID",
                        "GRADE.2016.MATHEMATICS", "GRADE.2016.ELA", "GRADE.2017.MATHEMATICS",
                        "GRADE.2017.ELA", "GRADE.2018.MATHEMATICS", "GRADE.2018.ELA",
                        "GRADE.2019.MATHEMATICS", "GRADE.2019.ELA", "GRADE.2021.MATHEMATICS", "GRADE.2021.ELA",
                        "SCALE_SCORE.2016.MATHEMATICS", "SCALE_SCORE.2016.ELA", "SCALE_SCORE.2017.MATHEMATICS",
                        "SCALE_SCORE.2017.ELA", "SCALE_SCORE.2018.MATHEMATICS", "SCALE_SCORE.2018.ELA",
                        "SCALE_SCORE.2019.MATHEMATICS", "SCALE_SCORE.2019.ELA", "SCALE_SCORE.2021.MATHEMATICS", "SCALE_SCORE.2021.ELA",
                        "SCHOOL_NUMBER.2016.MATHEMATICS", "SCHOOL_NUMBER.2016.ELA", "SCHOOL_NUMBER.2017.MATHEMATICS",
                        "SCHOOL_NUMBER.2017.ELA", "SCHOOL_NUMBER.2018.MATHEMATICS", "SCHOOL_NUMBER.2018.ELA", "SCHOOL_NUMBER.2019.MATHEMATICS",
                        "SCHOOL_NUMBER.2019.ELA", "SCHOOL_NUMBER.2021.MATHEMATICS", "SCHOOL_NUMBER.2021.ELA",
                        "DISTRICT_NUMBER.2016.MATHEMATICS", "DISTRICT_NUMBER.2016.ELA", "DISTRICT_NUMBER.2017.MATHEMATICS", "DISTRICT_NUMBER.2017.ELA", "DISTRICT_NUMBER.2018.MATHEMATICS",
                        "DISTRICT_NUMBER.2018.ELA", "DISTRICT_NUMBER.2019.MATHEMATICS", "DISTRICT_NUMBER.2019.ELA", "DISTRICT_NUMBER.2021.MATHEMATICS", "DISTRICT_NUMBER.2021.ELA"
                    )

Demonstration_COVID_SGP_WIDE_Data_ACTUAL <- copy(Demonstration_COVID_SGP_WIDE_Data[,variables.to.keep, with=FALSE])
Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017 <- copy(Demonstration_COVID_SGP_WIDE_Data[,variables.to.keep, with=FALSE])
Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016 <- copy(Demonstration_COVID_SGP_WIDE_Data[,variables.to.keep, with=FALSE])

### Break Scale for 2017 prior on sgpData_LONG_ASSESSMENT_CHANGE_2017

math.change <- 1000+rnorm(dim(Demonstration_COVID_SGP_WIDE_Data_ACTUAL)[1], sd=10)
ela.change <- 1000+rnorm(dim(Demonstration_COVID_SGP_WIDE_Data_ACTUAL)[1], sd=10)

Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017[,SCALE_SCORE.2016.MATHEMATICS:=SCALE_SCORE.2016.MATHEMATICS + math.change]
Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017[,SCALE_SCORE.2017.MATHEMATICS:=SCALE_SCORE.2017.MATHEMATICS + math.change]

Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017[,SCALE_SCORE.2016.ELA:=SCALE_SCORE.2016.ELA + ela.change]
Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017[,SCALE_SCORE.2017.ELA:=SCALE_SCORE.2017.ELA + ela.change]

Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016[,SCALE_SCORE.2016.MATHEMATICS:=SCALE_SCORE.2016.MATHEMATICS + math.change]

Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016[,SCALE_SCORE.2016.ELA:=SCALE_SCORE.2016.ELA + ela.change]

save(Demonstration_COVID_SGP_WIDE_Data_ACTUAL, file="Data/ACTUAL/Demonstration_COVID_SGP_WIDE_Data_ACTUAL.Rdata")
save(Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016, file="Data/ASSESSMENT_CHANGE_2016/Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016.Rdata")
save(Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017, file="Data/ASSESSMENT_CHANGE_2017/Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017.Rdata")

### Look at correlations between scale scores from adjacent years

corr.actual.math.2019 <- Demonstration_COVID_SGP_WIDE_Data_ACTUAL[GRADE.2019.MATHEMATICS > 4, cor(SCALE_SCORE.2019.MATHEMATICS, SCALE_SCORE.2017.MATHEMATICS, use="na.or.complete"), keyby="GRADE.2019.MATHEMATICS"]
corr.c17.math.2019 <- Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017[GRADE.2019.MATHEMATICS > 4, cor(SCALE_SCORE.2019.MATHEMATICS, SCALE_SCORE.2017.MATHEMATICS, use="na.or.complete"), keyby="GRADE.2019.MATHEMATICS"]
corr.c16.math.2019 <- Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016[GRADE.2019.MATHEMATICS > 4, cor(SCALE_SCORE.2019.MATHEMATICS, SCALE_SCORE.2017.MATHEMATICS, use="na.or.complete"), keyby="GRADE.2019.MATHEMATICS"]

print("Scale score correlations: 2017 to 2019, Mathematics")
print(dt.corr.math.2017_to_2019 <- data.table(
    GRADE=corr.actual.math.2019$GRADE.2019.MATHEMATICS,
    COR_ACTUAL_MATH_2017_to_2019=corr.actual.math.2019$V1,
    COR_CHANGE_2017_MATH_2017_to_2019=corr.c17.math.2019$V1,
    COR_CHANGE_2016_MATH_2017_to_2019=corr.c16.math.2019$V1
))

corr.actual.ela.2019 <- Demonstration_COVID_SGP_WIDE_Data_ACTUAL[GRADE.2019.ELA > 4, cor(SCALE_SCORE.2019.ELA, SCALE_SCORE.2017.ELA, use="na.or.complete"), keyby="GRADE.2019.ELA"]
corr.c17.ela.2019 <- Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017[GRADE.2019.ELA > 4, cor(SCALE_SCORE.2019.ELA, SCALE_SCORE.2017.ELA, use="na.or.complete"), keyby="GRADE.2019.ELA"]
corr.c16.ela.2019 <- Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016[GRADE.2019.ELA > 4, cor(SCALE_SCORE.2019.ELA, SCALE_SCORE.2017.ELA, use="na.or.complete"), keyby="GRADE.2019.ELA"]

print("Scale score correlations: 2017 to 2019, ELA")
print(dt.corr.ela.2017_to_2019 <- data.table(
    GRADE=corr.actual.ela.2019$GRADE.2019.ELA,
    COR_ACTUAL_ELA_2017_to_2019=corr.actual.ela.2019$V1,
    COR_CHANGE_2017_ELA_2017_to_2019=corr.c17.ela.2019$V1,
    COR_CHANGE_2016_ELA_2017_to_2019=corr.c16.ela.2019$V1
))

corr.actual.math.2016_2019 <- Demonstration_COVID_SGP_WIDE_Data_ACTUAL[GRADE.2019.MATHEMATICS > 5,cor(SCALE_SCORE.2019.MATHEMATICS, SCALE_SCORE.2016.MATHEMATICS, use="na.or.complete"), keyby="GRADE.2019.MATHEMATICS"]
corr.c17.math.2016_2019 <- Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017[GRADE.2019.MATHEMATICS > 5, cor(SCALE_SCORE.2019.MATHEMATICS, SCALE_SCORE.2016.MATHEMATICS, use="na.or.complete"), keyby="GRADE.2019.MATHEMATICS"]
corr.c16.math.2016_2019 <- Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016[GRADE.2019.MATHEMATICS > 5,cor(SCALE_SCORE.2019.MATHEMATICS, SCALE_SCORE.2016.MATHEMATICS, use="na.or.complete"), keyby="GRADE.2019.MATHEMATICS"]

print("Scale score correlations: 2016 to 2019, Mathematics")
print(dt.corr.math.2016_to_2019 <- data.table(
    GRADE=corr.actual.math.2016_2019$GRADE.2019.MATHEMATICS,
    COR_ACTUAL_MATH_2016_to_2019=corr.actual.math.2016_2019$V1,
    COR_CHANGE_2021_MATH_2016_to_2019=corr.c17.math.2016_2019$V1,
    COR_CHANGE_2019_MATH_2016_to_2019=corr.c16.math.2016_2019$V1
))

corr.actual.ela.2016_2019 <- Demonstration_COVID_SGP_WIDE_Data_ACTUAL[GRADE.2019.ELA > 5,cor(SCALE_SCORE.2019.ELA, SCALE_SCORE.2016.ELA, use="na.or.complete"), keyby="GRADE.2019.ELA"]
corr.c17.ela.2016_2019 <- Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017[GRADE.2019.ELA > 5, cor(SCALE_SCORE.2019.ELA, SCALE_SCORE.2016.ELA, use="na.or.complete"), keyby="GRADE.2019.ELA"]
corr.c16.ela.2016_2019 <- Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016[GRADE.2019.ELA > 5,cor(SCALE_SCORE.2019.ELA, SCALE_SCORE.2016.ELA, use="na.or.complete"), keyby="GRADE.2019.ELA"]

print("Scale score correlations: 2016 to 2018, ELA")
print(dt.corr.ela.2016_to_2019 <- data.table(
    GRADE=corr.actual.ela.2016_2019$GRADE.2019.ELA,
    COR_ACTUAL_ELA_2016_to_2019=corr.actual.ela.2016_2019$V1,
    COR_CHANGE_2021_ELA_2016_to_2019=corr.c17.ela.2016_2019$V1,
    COR_CHANGE_2019_ELA_2016_to_2019=corr.c16.ela.2016_2019$V1
))

### Create LONG data from WIDE files

attach(Demonstration_COVID_SGP_WIDE_Data_ACTUAL)
Demonstration_COVID_SGP_LONG_Data_ACTUAL <-
    data.table(
            VALID_CASE="VALID_CASE",
            CONTENT_AREA=c(rep("MATHEMATICS", length(ID)*5), rep("ELA", length(ID)*5)),
            YEAR=rep(c(rep("2016", length(ID)), rep("2017", length(ID)), rep("2018", length(ID)), rep("2019", length(ID)), rep("2021", length(ID))), 2),
            ID=rep(ID, 10),
            GRADE=c(GRADE.2016.MATHEMATICS, GRADE.2017.MATHEMATICS, GRADE.2018.MATHEMATICS, GRADE.2019.MATHEMATICS, GRADE.2021.MATHEMATICS,
                    GRADE.2016.ELA, GRADE.2017.ELA, GRADE.2018.ELA, GRADE.2019.ELA, GRADE.2021.ELA),
            SCALE_SCORE=c(SCALE_SCORE.2016.MATHEMATICS, SCALE_SCORE.2017.MATHEMATICS, SCALE_SCORE.2018.MATHEMATICS, SCALE_SCORE.2019.MATHEMATICS, SCALE_SCORE.2021.MATHEMATICS,
                    SCALE_SCORE.2016.ELA, SCALE_SCORE.2017.ELA, SCALE_SCORE.2018.ELA, SCALE_SCORE.2019.ELA, SCALE_SCORE.2021.ELA),
            SCHOOL_NUMBER=c(SCHOOL_NUMBER.2016.MATHEMATICS, SCHOOL_NUMBER.2017.MATHEMATICS, SCHOOL_NUMBER.2018.MATHEMATICS, SCHOOL_NUMBER.2019.MATHEMATICS, SCHOOL_NUMBER.2021.MATHEMATICS,
                    SCHOOL_NUMBER.2016.ELA, SCHOOL_NUMBER.2017.ELA, SCHOOL_NUMBER.2018.ELA, SCHOOL_NUMBER.2019.ELA, SCHOOL_NUMBER.2021.ELA),
            DISTRICT_NUMBER=c(DISTRICT_NUMBER.2016.MATHEMATICS, DISTRICT_NUMBER.2017.MATHEMATICS, DISTRICT_NUMBER.2018.MATHEMATICS, DISTRICT_NUMBER.2019.MATHEMATICS, DISTRICT_NUMBER.2021.MATHEMATICS,
                    DISTRICT_NUMBER.2016.ELA, DISTRICT_NUMBER.2017.ELA, DISTRICT_NUMBER.2018.ELA, DISTRICT_NUMBER.2019.ELA, DISTRICT_NUMBER.2021.ELA))
detach(Demonstration_COVID_SGP_WIDE_Data_ACTUAL)
Demonstration_COVID_SGP_LONG_Data_ACTUAL <- Demonstration_COVID_SGP_LONG_Data_ACTUAL[!is.na(GRADE)]
for (content_area.iter in c("ELA", "MATHEMATICS")) {
    for (grade.iter in as.character(3:8)) {
        tmp.loss.hoss <- SGPstateData[['DEMO_COVID']][['Achievement']][['Knots_Boundaries']][[content_area.iter]][[paste('loss.hoss', grade.iter, sep="_")]]
        Demonstration_COVID_SGP_LONG_Data_ACTUAL[SCALE_SCORE < tmp.loss.hoss[1], SCALE_SCORE:=tmp.loss.hoss[1]]
        Demonstration_COVID_SGP_LONG_Data_ACTUAL[SCALE_SCORE > tmp.loss.hoss[2], SCALE_SCORE:=tmp.loss.hoss[2]]
    }
}
setkey(Demonstration_COVID_SGP_LONG_Data_ACTUAL, VALID_CASE, CONTENT_AREA, YEAR, ID)


### CREATE LONG data for Assessment change 2016

attach(Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016)
Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2016 <-
    data.table(
            VALID_CASE="VALID_CASE",
            CONTENT_AREA=c(rep("MATHEMATICS", length(ID)*5), rep("ELA", length(ID)*5)),
            YEAR=rep(c(rep("2016", length(ID)), rep("2017", length(ID)), rep("2018", length(ID)), rep("2019", length(ID)), rep("2021", length(ID))), 2),
            ID=rep(ID, 10),
            GRADE=c(GRADE.2016.MATHEMATICS, GRADE.2017.MATHEMATICS, GRADE.2018.MATHEMATICS, GRADE.2019.MATHEMATICS, GRADE.2021.MATHEMATICS,
                    GRADE.2016.ELA, GRADE.2017.ELA, GRADE.2018.ELA, GRADE.2019.ELA, GRADE.2021.ELA),
            SCALE_SCORE=c(SCALE_SCORE.2016.MATHEMATICS, SCALE_SCORE.2017.MATHEMATICS, SCALE_SCORE.2018.MATHEMATICS, SCALE_SCORE.2019.MATHEMATICS, SCALE_SCORE.2021.MATHEMATICS,
                    SCALE_SCORE.2016.ELA, SCALE_SCORE.2017.ELA, SCALE_SCORE.2018.ELA, SCALE_SCORE.2019.ELA, SCALE_SCORE.2021.ELA),
            SCHOOL_NUMBER=c(SCHOOL_NUMBER.2016.MATHEMATICS, SCHOOL_NUMBER.2017.MATHEMATICS, SCHOOL_NUMBER.2018.MATHEMATICS, SCHOOL_NUMBER.2019.MATHEMATICS, SCHOOL_NUMBER.2021.MATHEMATICS,
                    SCHOOL_NUMBER.2016.ELA, SCHOOL_NUMBER.2017.ELA, SCHOOL_NUMBER.2018.ELA, SCHOOL_NUMBER.2019.ELA, SCHOOL_NUMBER.2021.ELA),
            DISTRICT_NUMBER=c(DISTRICT_NUMBER.2016.MATHEMATICS, DISTRICT_NUMBER.2017.MATHEMATICS, DISTRICT_NUMBER.2018.MATHEMATICS, DISTRICT_NUMBER.2019.MATHEMATICS, DISTRICT_NUMBER.2021.MATHEMATICS,
                    DISTRICT_NUMBER.2016.ELA, DISTRICT_NUMBER.2017.ELA, DISTRICT_NUMBER.2018.ELA, DISTRICT_NUMBER.2019.ELA, DISTRICT_NUMBER.2021.ELA))
detach(Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2016)
Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2016 <- Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2016[!is.na(GRADE)]
setkey(Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2016, VALID_CASE, CONTENT_AREA, YEAR, ID)


### CREATE LONG data for Assessment change 2017

attach(Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017)
Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2017 <-
    data.table(
            VALID_CASE="VALID_CASE",
            CONTENT_AREA=c(rep("MATHEMATICS", length(ID)*5), rep("ELA", length(ID)*5)),
            YEAR=rep(c(rep("2016", length(ID)), rep("2017", length(ID)), rep("2018", length(ID)), rep("2019", length(ID)), rep("2021", length(ID))), 2),
            ID=rep(ID, 10),
            GRADE=c(GRADE.2016.MATHEMATICS, GRADE.2017.MATHEMATICS, GRADE.2018.MATHEMATICS, GRADE.2019.MATHEMATICS, GRADE.2021.MATHEMATICS,
                    GRADE.2016.ELA, GRADE.2017.ELA, GRADE.2018.ELA, GRADE.2019.ELA, GRADE.2021.ELA),
            SCALE_SCORE=c(SCALE_SCORE.2016.MATHEMATICS, SCALE_SCORE.2017.MATHEMATICS, SCALE_SCORE.2018.MATHEMATICS, SCALE_SCORE.2019.MATHEMATICS, SCALE_SCORE.2021.MATHEMATICS,
                    SCALE_SCORE.2016.ELA, SCALE_SCORE.2017.ELA, SCALE_SCORE.2018.ELA, SCALE_SCORE.2019.ELA, SCALE_SCORE.2021.ELA),
            SCHOOL_NUMBER=c(SCHOOL_NUMBER.2016.MATHEMATICS, SCHOOL_NUMBER.2017.MATHEMATICS, SCHOOL_NUMBER.2018.MATHEMATICS, SCHOOL_NUMBER.2019.MATHEMATICS, SCHOOL_NUMBER.2021.MATHEMATICS,
                    SCHOOL_NUMBER.2016.ELA, SCHOOL_NUMBER.2017.ELA, SCHOOL_NUMBER.2018.ELA, SCHOOL_NUMBER.2019.ELA, SCHOOL_NUMBER.2021.ELA),
            DISTRICT_NUMBER=c(DISTRICT_NUMBER.2016.MATHEMATICS, DISTRICT_NUMBER.2017.MATHEMATICS, DISTRICT_NUMBER.2018.MATHEMATICS, DISTRICT_NUMBER.2019.MATHEMATICS, DISTRICT_NUMBER.2021.MATHEMATICS,
                    DISTRICT_NUMBER.2016.ELA, DISTRICT_NUMBER.2017.ELA, DISTRICT_NUMBER.2018.ELA, DISTRICT_NUMBER.2019.ELA, DISTRICT_NUMBER.2021.ELA))
detach(Demonstration_COVID_SGP_WIDE_Data_ASSESSMENT_CHANGE_2017)
Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2017 <- Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2017[!is.na(GRADE)]
setkey(Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2017, VALID_CASE, CONTENT_AREA, YEAR, ID)


### Save LONG data files

save(Demonstration_COVID_SGP_LONG_Data_ACTUAL, file="Data/ACTUAL/Demonstration_COVID_SGP_LONG_Data_ACTUAL.Rdata")
save(Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2016, file="Data/ASSESSMENT_CHANGE_2016/Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2016.Rdata")
save(Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2017, file="Data/ASSESSMENT_CHANGE_2017/Demonstration_COVID_SGP_LONG_Data_ASSESSMENT_CHANGE_2017.Rdata")
